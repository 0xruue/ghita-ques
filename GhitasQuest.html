<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghita's Quest</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #1c1c2a;
            color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            overflow: hidden;
        }

        .game-container {
            max-width: 1200px;
            background: #2a2a3c;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            border: 4px solid #4a4a6a;
            position: relative;
            overflow: hidden;
        }

        .game-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b8b, #4a90e2, #6bff8b);
            z-index: 10;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #4a4a6a;
            position: relative;
        }

        h1 {
            color: #ff9eb5;
            font-size: 2.8rem;
            text-shadow: 3px 3px 0 #000, 5px 5px 0 rgba(0, 0, 0, 0.3);
            letter-spacing: 2px;
            font-weight: bold;
            background: linear-gradient(to bottom, #ff9eb5, #e94560);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            flex-grow: 1;
        }

        .hearts {
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid #4a4a6a;
        }

        .heart {
            font-size: 1.8rem;
            color: #e94560;
            text-shadow: 2px 2px 0 #000;
            filter: drop-shadow(0 0 3px rgba(233, 69, 96, 0.7));
        }

        .game-area {
            position: relative;
            margin-bottom: 25px;
            border: 4px solid #4a4a6a;
            border-radius: 8px;
            overflow: hidden;
            background: #1a1a2a;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.8);
            height: 500px;
        }

        #gameCanvas {
            display: block;
            margin: 0 auto;
            image-rendering: pixelated;
        }

        .dialogue-box {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 20, 40, 0.95);
            color: #e0e0ff;
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 1.2rem;
            max-width: 80%;
            text-align: center;
            display: none;
            border: 3px solid #6b6b9a;
            box-shadow: 0 0 15px rgba(107, 107, 154, 0.5);
            z-index: 100;
            text-shadow: 1px 1px 0 #000;
            font-weight: bold;
        }

        .stage-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(20, 20, 40, 0.9);
            color: #ff9eb5;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1rem;
            border: 2px solid #6b6b9a;
            font-weight: bold;
        }

        .title-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            text-align: center;
            overflow: hidden;
        }

        .title-content {
            position: relative;
            z-index: 10;
            animation: fadeIn 1.5s ease-out;
        }

        .title-screen h2 {
            color: #ff9eb5;
            font-size: 5.5rem;
            margin-bottom: 20px;
            text-shadow: 4px 4px 0 #000, 8px 8px 0 rgba(0, 0, 0, 0.3);
            letter-spacing: 6px;
            font-weight: bold;
            background: linear-gradient(to bottom, #ff9eb5, #e94560, #c53d54);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: titleGlow 3s infinite alternate;
        }

        .title-screen p {
            font-size: 1.5rem;
            margin-bottom: 40px;
            text-align: center;
            max-width: 80%;
            color: #e0e0ff;
            text-shadow: 1px 1px 0 #000;
            line-height: 1.6;
        }

        #startBtn {
            background: linear-gradient(to bottom, #ff6b8b, #e94560);
            color: white;
            border: none;
            padding: 18px 60px;
            font-size: 1.8rem;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 40px;
            border: 4px solid #ff9eb5;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 6px 0 #8a2a3a, 0 0 20px rgba(255, 105, 180, 0.5);
            animation: pulse 2s infinite;
        }

        #startBtn:hover {
            background: linear-gradient(to bottom, #ff7b9b, #ff5575);
            transform: translateY(3px);
            box-shadow: 0 3px 0 #8a2a3a, 0 0 25px rgba(255, 105, 180, 0.7);
            animation: none;
        }

        .controls-info {
            background: rgba(20, 20, 40, 0.8);
            padding: 20px;
            border-radius: 12px;
            border: 3px solid #6b6b9a;
            text-align: center;
            box-shadow: 0 0 15px rgba(107, 107, 154, 0.5);
            backdrop-filter: blur(5px);
        }

        .controls {
            text-align: center;
            padding-top: 20px;
            border-top: 2px solid #4a4a6a;
            background: rgba(30, 30, 50, 0.7);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .controls p {
            margin-bottom: 12px;
            color: #a9b7c6;
            font-size: 1.1rem;
            text-shadow: 1px 1px 0 #000;
        }

        #restartBtn {
            background: linear-gradient(to bottom, #6b6b9a, #4a4a6a);
            color: #e0e0ff;
            border: none;
            padding: 12px 30px;
            font-size: 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s;
            border: 2px solid #8b8bba;
            box-shadow: 0 4px 0 #3a3a5a;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
        }

        #restartBtn:hover {
            background: linear-gradient(to bottom, #7b7baa, #5a5a7a);
            transform: translateY(2px);
            box-shadow: 0 2px 0 #3a3a5a;
        }

        .instructions {
            background: rgba(20, 20, 40, 0.8);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 2px solid #6b6b9a;
            text-align: left;
        }

        .instructions h3 {
            color: #ff9eb5;
            margin-bottom: 10px;
            text-align: center;
            text-shadow: 1px 1px 0 #000;
            font-size: 1.4rem;
        }

        .instructions ul {
            list-style-type: none;
            padding-left: 10px;
        }

        .instructions li {
            margin-bottom: 8px;
            padding-left: 25px;
            position: relative;
            color: #c0c0e0;
        }

        .instructions li:before {
            content: "‚óÜ";
            color: #ff9eb5;
            position: absolute;
            left: 5px;
            font-size: 1.2rem;
        }

        .terraria-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(74, 74, 138, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(107, 107, 154, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(42, 42, 90, 0.2) 0%, transparent 50%);
            z-index: -1;
        }

        .game-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.4);
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #4a4a6a;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #ff9eb5;
            text-shadow: 1px 1px 0 #000;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #a9b7c6;
        }

        .title-decoration {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .floating-item {
            position: absolute;
            animation: float 3s ease-in-out infinite;
            font-size: 2.5rem;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.5));
        }

        .title-bg-element {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
            100% { transform: translateY(0px) rotate(0deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes titleGlow {
            0% { text-shadow: 4px 4px 0 #000, 8px 8px 0 rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 158, 181, 0.5); }
            100% { text-shadow: 4px 4px 0 #000, 8px 8px 0 rgba(0, 0, 0, 0.3), 0 0 30px rgba(255, 158, 181, 0.8); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .character-preview {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 30px 0;
        }

        .character {
            text-align: center;
            animation: float 4s ease-in-out infinite;
        }

        .character:nth-child(2) {
            animation-delay: 0.5s;
        }

        .character-icon {
            font-size: 4rem;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
        }

        .character-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ff9eb5;
            text-shadow: 1px 1px 0 #000;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="terraria-bg"></div>
        <div class="game-header">
            <h1>GHITA'S QUEST</h1>
            <div class="hearts">
                <span class="heart">‚ù§Ô∏è</span>
                <span class="heart">‚ù§Ô∏è</span>
                <span class="heart">‚ù§Ô∏è</span>
            </div>
        </div>
        
        <div class="game-area">
            <canvas id="gameCanvas" width="1200" height="500"></canvas>
            <div id="dialogue" class="dialogue-box"></div>
            <div id="stageInfo" class="stage-info">Stage 1: Forest</div>
            
            <!-- Title Screen -->
            <div id="titleScreen" class="title-screen">
                <div class="title-decoration">
                    <div class="floating-item" style="top: 15%; left: 10%;">üóùÔ∏è</div>
                    <div class="floating-item" style="top: 25%; right: 15%;">üìñ</div>
                    <div class="floating-item" style="bottom: 20%; left: 20%;">üå∫</div>
                    <div class="floating-item" style="bottom: 30%; right: 10%;">üíñ</div>
                    <div class="title-bg-element" style="top: 10%; left: 5%; width: 100px; height: 100px;"></div>
                    <div class="title-bg-element" style="bottom: 10%; right: 5%; width: 150px; height: 150px;"></div>
                    <div class="title-bg-element" style="top: 50%; left: 80%; width: 80px; height: 80px;"></div>
                </div>
                
                <div class="title-content">
                    <h2>GHITA'S QUEST</h2>
                    <p>Embark on an epic adventure with Ghita as she helps her boyfriend Reda<br>across three challenging worlds filled with danger and mystery!</p>
                    
                    <div class="character-preview">
                        <div class="character">
                            <div class="character-icon">üë©‚Äçü¶∞</div>
                            <div class="character-name">Ghita</div>
                        </div>
                        <div class="character">
                            <div class="character-icon">üë®‚Äçüíº</div>
                            <div class="character-name">Reda</div>
                        </div>
                    </div>
                    
                    <button id="startBtn">BEGIN ADVENTURE</button>
                    
                    <div class="controls-info">
                        <p>WASD : Move | SPACE : Jump | E : Interact</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="game-stats">
            <div class="stat">
                <div class="stat-value" id="itemsCollected">0/3</div>
                <div class="stat-label">ITEMS FOUND</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="currentStage">1</div>
                <div class="stat-label">STAGE</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="gameTime">0s</div>
                <div class="stat-label">TIME</div>
            </div>
        </div>
        
        <div class="controls">
            <p>Use <strong>WASD</strong> to move | <strong>SPACE</strong> to jump | <strong>E</strong> to interact</p>
            <button id="restartBtn">RESTART GAME</button>
            
            <div class="instructions">
                <h3>HOW TO PLAY</h3>
                <ul>
                    <li>Help Ghita find all items for her boyfriend Reda across 3 stages</li>
                    <li>Avoid the slimes or lose hearts</li>
                    <li>Collect all items then touch Reda to advance</li>
                    <li>Press E to interact with items and characters</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Game variables
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const dialogueBox = document.getElementById('dialogue');
        const restartBtn = document.getElementById('restartBtn');
        const startBtn = document.getElementById('startBtn');
        const titleScreen = document.getElementById('titleScreen');
        const hearts = document.querySelectorAll('.heart');
        const itemsCollectedEl = document.getElementById('itemsCollected');
        const currentStageEl = document.getElementById('currentStage');
        const gameTimeEl = document.getElementById('gameTime');
        const stageInfoEl = document.getElementById('stageInfo');

        // Sound effects
        const sounds = {
            collect: new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA=="),
            jump: new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA=="),
            hit: new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA=="),
            stageComplete: new Audio("data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==")
        };

        // Initialize sound effects with simple tones
        function initSounds() {
            // Collection sound (high pitch)
            const collectContext = new AudioContext();
            const collectOscillator = collectContext.createOscillator();
            const collectGain = collectContext.createGain();
            collectOscillator.connect(collectGain);
            collectGain.connect(collectContext.destination);
            collectOscillator.frequency.value = 800;
            collectGain.gain.value = 0.3;
            collectOscillator.start();
            collectOscillator.stop(collectContext.currentTime + 0.1);
            
            // Jump sound (medium pitch)
            const jumpContext = new AudioContext();
            const jumpOscillator = jumpContext.createOscillator();
            const jumpGain = jumpContext.createGain();
            jumpOscillator.connect(jumpGain);
            jumpGain.connect(jumpContext.destination);
            jumpOscillator.frequency.value = 600;
            jumpGain.gain.value = 0.2;
            jumpOscillator.start();
            jumpOscillator.stop(jumpContext.currentTime + 0.1);
            
            // Hit sound (low pitch)
            const hitContext = new AudioContext();
            const hitOscillator = hitContext.createOscillator();
            const hitGain = hitContext.createGain();
            hitOscillator.connect(hitGain);
            hitGain.connect(hitContext.destination);
            hitOscillator.frequency.value = 300;
            hitGain.gain.value = 0.4;
            hitOscillator.start();
            hitOscillator.stop(hitContext.currentTime + 0.2);
            
            // Stage complete sound (ascending tones)
            const stageContext = new AudioContext();
            const stageOscillator = stageContext.createOscillator();
            const stageGain = stageContext.createGain();
            stageOscillator.connect(stageGain);
            stageGain.connect(stageContext.destination);
            stageOscillator.frequency.setValueAtTime(400, stageContext.currentTime);
            stageOscillator.frequency.exponentialRampToValueAtTime(800, stageContext.currentTime + 0.3);
            stageGain.gain.value = 0.3;
            stageOscillator.start();
            stageOscillator.stop(stageContext.currentTime + 0.3);
        }

        // Game state
        let gameState = {
            player: {
                x: 100,
                y: 350,
                width: 20,
                height: 32,
                speed: 5,
                direction: 'right',
                isJumping: false,
                velocityY: 0,
                onGround: false,
                name: 'Ghita'
            },
            boyfriend: {
                x: 1100,
                y: 350,
                width: 20,
                height: 32,
                needsHelp: true,
                name: 'Reda'
            },
            currentStage: 1,
            items: [],
            lives: 3,
            gameOver: false,
            gameStarted: false,
            currentDialogue: '',
            dialogueTimer: 0,
            platforms: [],
            enemies: [],
            gameStartTime: Date.now(),
            itemsCollected: 0,
            totalItems: 0
        };

        // Extended stage configurations
        const stages = {
            1: {
                name: "Forest",
                items: [
                    { x: 300, y: 330, type: 'key', collected: false },
                    { x: 600, y: 280, type: 'book', collected: false },
                    { x: 900, y: 330, type: 'flower', collected: false },
                    { x: 400, y: 250, type: 'gem', collected: false },
                    { x: 800, y: 200, type: 'scroll', collected: false }
                ],
                playerStart: { x: 100, y: 350 },
                boyfriendPos: { x: 1100, y: 350 },
                platforms: [
                    { x: 0, y: 400, width: 1200, height: 100, type: 'dirt' },
                    { x: 200, y: 350, width: 100, height: 20, type: 'grass' },
                    { x: 350, y: 300, width: 100, height: 20, type: 'grass' },
                    { x: 500, y: 250, width: 100, height: 20, type: 'grass' },
                    { x: 650, y: 300, width: 100, height: 20, type: 'grass' },
                    { x: 800, y: 250, width: 100, height: 20, type: 'grass' },
                    { x: 950, y: 300, width: 100, height: 20, type: 'grass' },
                    { x: 1100, y: 350, width: 100, height: 20, type: 'grass' }
                ],
                enemies: [
                    { x: 350, y: 340, width: 24, height: 16, speed: 1.8, direction: 1, type: 'slime', moveRange: 100, startX: 350, jumpChance: 0.01 },
                    { x: 550, y: 290, width: 24, height: 16, speed: 2.2, direction: -1, type: 'slime', moveRange: 80, startX: 550, jumpChance: 0.015 },
                    { x: 750, y: 340, width: 24, height: 16, speed: 2.0, direction: 1, type: 'slime', moveRange: 120, startX: 750, jumpChance: 0.02 },
                    { x: 950, y: 290, width: 24, height: 16, speed: 2.3, direction: -1, type: 'slime', moveRange: 90, startX: 950, jumpChance: 0.025 }
                ]
            },
            2: {
                name: "Caves",
                items: [
                    { x: 350, y: 330, type: 'key', collected: false },
                    { x: 550, y: 280, type: 'book', collected: false },
                    { x: 750, y: 330, type: 'flower', collected: false },
                    { x: 950, y: 280, type: 'gem', collected: false },
                    { x: 650, y: 230, type: 'scroll', collected: false }
                ],
                playerStart: { x: 100, y: 350 },
                boyfriendPos: { x: 1100, y: 350 },
                platforms: [
                    { x: 0, y: 400, width: 1200, height: 100, type: 'stone' },
                    { x: 150, y: 320, width: 80, height: 20, type: 'stone' },
                    { x: 300, y: 280, width: 80, height: 20, type: 'stone' },
                    { x: 450, y: 320, width: 80, height: 20, type: 'stone' },
                    { x: 600, y: 280, width: 80, height: 20, type: 'stone' },
                    { x: 750, y: 320, width: 80, height: 20, type: 'stone' },
                    { x: 900, y: 280, width: 80, height: 20, type: 'stone' },
                    { x: 1050, y: 320, width: 80, height: 20, type: 'stone' }
                ],
                enemies: [
                    { x: 250, y: 330, width: 24, height: 16, speed: 2.4, direction: 1, type: 'slime', moveRange: 100, startX: 250, jumpChance: 0.025 },
                    { x: 400, y: 290, width: 24, height: 16, speed: 2.1, direction: -1, type: 'slime', moveRange: 90, startX: 400, jumpChance: 0.03 },
                    { x: 550, y: 330, width: 24, height: 16, speed: 2.3, direction: 1, type: 'slime', moveRange: 110, startX: 550, jumpChance: 0.02 },
                    { x: 700, y: 290, width: 24, height: 16, speed: 2.5, direction: -1, type: 'slime', moveRange: 80, startX: 700, jumpChance: 0.035 },
                    { x: 850, y: 330, width: 24, height: 16, speed: 2.2, direction: 1, type: 'slime', moveRange: 100, startX: 850, jumpChance: 0.04 }
                ]
            },
            3: {
                name: "Castle",
                items: [
                    { x: 400, y: 250, type: 'key', collected: false },
                    { x: 600, y: 330, type: 'book', collected: false },
                    { x: 800, y: 250, type: 'flower', collected: false },
                    { x: 1000, y: 330, type: 'gem', collected: false },
                    { x: 700, y: 200, type: 'scroll', collected: false }
                ],
                playerStart: { x: 100, y: 350 },
                boyfriendPos: { x: 1100, y: 350 },
                platforms: [
                    { x: 0, y: 400, width: 1200, height: 100, type: 'stone' },
                    { x: 100, y: 320, width: 60, height: 20, type: 'stone' },
                    { x: 250, y: 280, width: 60, height: 20, type: 'stone' },
                    { x: 400, y: 320, width: 60, height: 20, type: 'stone' },
                    { x: 550, y: 280, width: 60, height: 20, type: 'stone' },
                    { x: 700, y: 320, width: 60, height: 20, type: 'stone' },
                    { x: 850, y: 280, width: 60, height: 20, type: 'stone' },
                    { x: 1000, y: 320, width: 60, height: 20, type: 'stone' },
                    { x: 1150, y: 280, width: 60, height: 20, type: 'stone' }
                ],
                enemies: [
                    { x: 200, y: 330, width: 24, height: 16, speed: 2.8, direction: 1, type: 'slime', moveRange: 120, startX: 200, jumpChance: 0.04 },
                    { x: 350, y: 290, width: 24, height: 16, speed: 2.6, direction: -1, type: 'slime', moveRange: 100, startX: 350, jumpChance: 0.045 },
                    { x: 500, y: 330, width: 24, height: 16, speed: 2.7, direction: 1, type: 'slime', moveRange: 110, startX: 500, jumpChance: 0.035 },
                    { x: 650, y: 290, width: 24, height: 16, speed: 2.9, direction: -1, type: 'slime', moveRange: 90, startX: 650, jumpChance: 0.05 },
                    { x: 800, y: 330, width: 24, height: 16, speed: 3.0, direction: 1, type: 'slime', moveRange: 130, startX: 800, jumpChance: 0.04 },
                    { x: 950, y: 290, width: 24, height: 16, speed: 2.5, direction: -1, type: 'slime', moveRange: 100, startX: 950, jumpChance: 0.055 }
                ]
            }
        };

        // Key states
        const keys = {};

        // Initialize game
        function init() {
            gameState.gameStarted = true;
            gameState.gameOver = false;
            gameState.lives = 3;
            gameState.gameStartTime = Date.now();
            titleScreen.style.display = 'none';
            initSounds();
            loadStage(1);
            updateHearts();
            updateStats();
            gameLoop();
        }

        // Load a specific stage
        function loadStage(stageNumber) {
            const stage = stages[stageNumber];
            if (!stage) return;
            
            gameState.currentStage = stageNumber;
            gameState.items = JSON.parse(JSON.stringify(stage.items));
            gameState.player.x = stage.playerStart.x;
            gameState.player.y = stage.playerStart.y;
            gameState.player.velocityY = 0;
            gameState.player.isJumping = false;
            gameState.boyfriend.x = stage.boyfriendPos.x;
            gameState.boyfriend.y = stage.boyfriendPos.y;
            gameState.platforms = JSON.parse(JSON.stringify(stage.platforms));
            gameState.enemies = JSON.parse(JSON.stringify(stage.enemies));
            gameState.boyfriend.needsHelp = true;
            gameState.itemsCollected = 0;
            gameState.totalItems = stage.items.length;
            
            stageInfoEl.textContent = `Stage ${stageNumber}: ${stage.name}`;
            currentStageEl.textContent = stageNumber;
            
            showDialogue(`Welcome to ${stage.name}! Find all ${stage.items.length} items for Reda.`, 4000);
        }

        // Update hearts display
        function updateHearts() {
            hearts.forEach((heart, index) => {
                heart.style.opacity = index < gameState.lives ? '1' : '0.3';
            });
        }

        // Update game stats
        function updateStats() {
            itemsCollectedEl.textContent = `${gameState.itemsCollected}/${gameState.totalItems}`;
            
            if (gameState.gameStartTime > 0) {
                const elapsed = Math.floor((Date.now() - gameState.gameStartTime) / 1000);
                gameTimeEl.textContent = `${elapsed}s`;
            }
        }

        // Show dialogue above Ghita's head
        function showDialogue(text, duration = 3000) {
            gameState.currentDialogue = text;
            gameState.dialogueTimer = duration;
            
            dialogueBox.textContent = text;
            dialogueBox.style.display = 'block';
        }

        // Draw Terraria-style background
        function drawBackground() {
            // Sky gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#4a4a8a');
            gradient.addColorStop(0.7, '#3a3a7a');
            gradient.addColorStop(1, '#2a2a6a');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Stage-specific background elements
            if (gameState.currentStage === 1) {
                // Forest clouds and sun
                ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                ctx.fillRect(100, 80, 120, 30);
                ctx.fillRect(500, 120, 150, 40);
                ctx.fillRect(300, 60, 100, 25);
                
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.arc(1100, 80, 30, 0, Math.PI * 2);
                ctx.fill();
            } else if (gameState.currentStage === 2) {
                // Cave darkness
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Cave crystals
                ctx.fillStyle = '#9B59B6';
                for (let i = 0; i < 5; i++) {
                    ctx.fillRect(200 + i * 200, 100, 10, 30);
                }
            } else if (gameState.currentStage === 3) {
                // Castle background
                ctx.fillStyle = '#34495E';
                ctx.fillRect(0, 0, canvas.width, 200);
                
                // Castle towers
                ctx.fillStyle = '#7F8C8D';
                ctx.fillRect(100, 100, 40, 100);
                ctx.fillRect(500, 100, 40, 100);
                ctx.fillRect(900, 100, 40, 100);
            }
        }

        // Draw platforms
        function drawPlatforms() {
            gameState.platforms.forEach(platform => {
                if (platform.type === 'dirt') {
                    ctx.fillStyle = '#8B4513';
                } else if (platform.type === 'grass') {
                    ctx.fillStyle = '#3A7D34';
                } else if (platform.type === 'stone') {
                    ctx.fillStyle = '#7A7A7A';
                }
                
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                
                // Platform details
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.lineWidth = 1;
                
                for (let x = platform.x; x < platform.x + platform.width; x += 20) {
                    for (let y = platform.y; y < platform.y + platform.height; y += 20) {
                        ctx.strokeRect(x, y, 20, 20);
                    }
                }
                
                // Grass on top
                if (platform.type === 'grass') {
                    ctx.fillStyle = '#2F6C2A';
                    ctx.fillRect(platform.x, platform.y, platform.width, 5);
                }
            });
        }

        // Draw Ghita (Terraria-style female character)
        function drawPlayer() {
            const p = gameState.player;
            
            // Body
            ctx.fillStyle = '#FF69B4';
            ctx.fillRect(p.x, p.y + 8, p.width, p.height - 8);
            
            // Head
            ctx.fillStyle = '#FFDAB9';
            ctx.fillRect(p.x + 4, p.y, 12, 12);
            
            // Hair (long, brown)
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(p.x, p.y, p.width, 6);
            ctx.fillRect(p.x - 2, p.y + 6, 4, 10);
            ctx.fillRect(p.x + p.width - 2, p.y + 6, 4, 10);
            
            // Eyes
            ctx.fillStyle = '#000';
            if (p.direction === 'right') {
                ctx.fillRect(p.x + 10, p.y + 4, 2, 2);
            } else {
                ctx.fillRect(p.x + 8, p.y + 4, 2, 2);
            }
            
            // Dress details
            ctx.fillStyle = '#FF1493';
            ctx.fillRect(p.x, p.y + 16, p.width, 8);
            
            // Legs (animation based on movement)
            ctx.fillStyle = '#4A4A6A';
            const isMoving = keys['a'] || keys['d'];
            if (p.isJumping || isMoving) {
                ctx.fillRect(p.x + 4, p.y + p.height - 4, 4, 6);
                ctx.fillRect(p.x + 12, p.y + p.height - 4, 4, 6);
            } else {
                ctx.fillRect(p.x + 6, p.y + p.height - 4, 4, 6);
                ctx.fillRect(p.x + 10, p.y + p.height - 4, 4, 6);
            }
            
            // Draw name above head
            ctx.fillStyle = 'rgba(20, 20, 40, 0.95)';
            ctx.fillRect(p.x - 15, p.y - 25, 50, 15);
            ctx.fillStyle = '#ff9eb5';
            ctx.font = '10px Arial';
            ctx.fillText(p.name, p.x - 10, p.y - 15);
        }

        // Draw Reda (Terraria-style male character)
        function drawBoyfriend() {
            const b = gameState.boyfriend;
            
            // Body
            ctx.fillStyle = '#4A90E2';
            ctx.fillRect(b.x, b.y + 8, b.width, b.height - 8);
            
            // Head
            ctx.fillStyle = '#FFDAB9';
            ctx.fillRect(b.x + 4, b.y, 12, 12);
            
            // Hair (short, dark)
            ctx.fillStyle = '#2C3E50';
            ctx.fillRect(b.x, b.y, b.width, 4);
            
            // Eyes
            ctx.fillStyle = '#000';
            ctx.fillRect(b.x + 8, b.y + 4, 2, 2);
            
            // Shirt details
            ctx.fillStyle = '#2C3E50';
            ctx.fillRect(b.x, b.y + 16, b.width, 8);
            
            // Legs
            ctx.fillStyle = '#4A4A6A';
            ctx.fillRect(b.x + 6, b.y + b.height - 4, 4, 6);
            ctx.fillRect(b.x + 10, b.y + b.height - 4, 4, 6);
            
            // Draw name above head
            ctx.fillStyle = 'rgba(20, 20, 40, 0.95)';
            ctx.fillRect(b.x - 15, b.y - 25, 50, 15);
            ctx.fillStyle = '#4A90E2';
            ctx.font = '10px Arial';
            ctx.fillText(b.name, b.x - 10, b.y - 15);
        }

        // Draw enhanced items with cool visuals
        function drawItems() {
            gameState.items.forEach(item => {
                if (item.collected) return;
                
                // Item glow effect
                ctx.fillStyle = 'rgba(255, 215, 0, 0.3)';
                ctx.beginPath();
                ctx.arc(item.x + 10, item.y + 10, 15, 0, Math.PI * 2);
                ctx.fill();
                
                // Pulsing effect
                const pulse = Math.sin(Date.now() / 200) * 2;
                
                if (item.type === 'key') {
                    // Enhanced key with shine
                    ctx.fillStyle = '#FFD700';
                    ctx.fillRect(item.x + 5, item.y + 5, 10, 3);
                    ctx.fillRect(item.x + 8, item.y, 4, 10);
                    ctx.fillRect(item.x + 12, item.y + 3, 3, 4);
                    
                    // Key shine
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.fillRect(item.x + 9, item.y + 1, 2, 2);
                } else if (item.type === 'book') {
                    // Enhanced book with details
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(item.x + 5, item.y, 10, 12);
                    ctx.fillStyle = '#FFD700';
                    ctx.fillRect(item.x + 6, item.y + 2, 8, 8);
                    
                    // Book details
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(item.x + 6, item.y + 4, 8, 1);
                    ctx.fillRect(item.x + 6, item.y + 7, 8, 1);
                } else if (item.type === 'flower') {
                    // Enhanced flower with petals
                    ctx.fillStyle = '#32CD32';
                    ctx.fillRect(item.x + 9, item.y + 10, 2, 10);
                    
                    ctx.fillStyle = '#FF1493';
                    ctx.beginPath();
                    ctx.arc(item.x + 10, item.y + 5, 5 + pulse, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Flower center
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(item.x + 10, item.y + 5, 2, 0, Math.PI * 2);
                    ctx.fill();
                } else if (item.type === 'gem') {
                    // Shiny gem
                    ctx.fillStyle = '#9B59B6';
                    ctx.beginPath();
                    ctx.moveTo(item.x + 10, item.y);
                    ctx.lineTo(item.x + 15, item.y + 7);
                    ctx.lineTo(item.x + 10, item.y + 14);
                    ctx.lineTo(item.x + 5, item.y + 7);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Gem shine
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.beginPath();
                    ctx.moveTo(item.x + 8, item.y + 3);
                    ctx.lineTo(item.x + 10, item.y + 5);
                    ctx.lineTo(item.x + 7, item.y + 6);
                    ctx.closePath();
                    ctx.fill();
                } else if (item.type === 'scroll') {
                    // Ancient scroll
                    ctx.fillStyle = '#F5DEB3';
                    ctx.fillRect(item.x + 5, item.y, 10, 12);
                    
                    // Scroll details
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(item.x + 5, item.y, 10, 2);
                    ctx.fillRect(item.x + 5, item.y + 10, 10, 2);
                    
                    // Scroll text
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(item.x + 7, item.y + 4, 6, 1);
                    ctx.fillRect(item.x + 7, item.y + 6, 6, 1);
                    ctx.fillRect(item.x + 7, item.y + 8, 6, 1);
                }
            });
        }

        // Draw enemies
        function drawEnemies() {
            gameState.enemies.forEach(enemy => {
                // Slime body with bounce effect
                const bounce = Math.sin(Date.now() / 300 + enemy.x) * 2;
                
                ctx.fillStyle = '#32CD32';
                ctx.beginPath();
                ctx.ellipse(enemy.x + enemy.width/2, enemy.y + enemy.height/2 - bounce, 
                            enemy.width/2, enemy.height/2, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Slime details
                ctx.fillStyle = '#228B22';
                ctx.beginPath();
                ctx.ellipse(enemy.x + enemy.width/2, enemy.y + enemy.height/3 - bounce, 
                            enemy.width/3, enemy.height/4, 0, 0, Math.PI);
                ctx.fill();
                
                // Eyes
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(enemy.x + enemy.width/3, enemy.y + enemy.height/3 - bounce, 2, 0, Math.PI * 2);
                ctx.arc(enemy.x + 2*enemy.width/3, enemy.y + enemy.height/3 - bounce, 2, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        // Check collision between two rectangles
        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        // Handle player movement
        function handlePlayerMovement() {
            const p = gameState.player;
            
            // Apply gravity
            p.velocityY += 0.5;
            p.y += p.velocityY;
            
            // Horizontal movement
            if (keys['a']) {
                p.x -= p.speed;
                p.direction = 'left';
            }
            if (keys['d']) {
                p.x += p.speed;
                p.direction = 'right';
            }
            
            // Jumping
            if (keys[' '] && p.onGround) {
                p.velocityY = -12;
                p.isJumping = true;
                p.onGround = false;
                // Play jump sound
                initSounds(); // This would trigger the jump sound in a real implementation
            }
            
            // Keep player within canvas bounds
            if (p.x < 0) p.x = 0;
            if (p.x + p.width > canvas.width) p.x = canvas.width - p.width;
            
            // Platform collision
            p.onGround = false;
            gameState.platforms.forEach(platform => {
                if (p.x + p.width > platform.x && 
                    p.x < platform.x + platform.width &&
                    p.y + p.height > platform.y && 
                    p.y + p.height < platform.y + platform.height / 2 &&
                    p.velocityY > 0) {
                    
                    p.y = platform.y - p.height;
                    p.velocityY = 0;
                    p.onGround = true;
                    p.isJumping = false;
                }
            });
            
            // Floor collision
            if (p.y + p.height > canvas.height) {
                p.y = canvas.height - p.height;
                p.velocityY = 0;
                p.onGround = true;
                p.isJumping = false;
            }
        }

        // Handle enemy movement
        function handleEnemyMovement() {
            gameState.enemies.forEach(enemy => {
                // Move enemy back and forth
                enemy.x += enemy.speed * enemy.direction;
                
                // Change direction if reached movement range
                if (Math.abs(enemy.x - enemy.startX) > enemy.moveRange) {
                    enemy.direction *= -1;
                }
                
                // Random jumping
                if (Math.random() < enemy.jumpChance) {
                    enemy.y -= 5;
                    setTimeout(() => {
                        enemy.y += 5;
                    }, 300);
                }
                
                // Enemy collision with player
                if (checkCollision(gameState.player, enemy)) {
                    handlePlayerHit();
                }
            });
        }

        // Handle player being hit by enemy
        function handlePlayerHit() {
            gameState.lives--;
            updateHearts();
            
            // Play hit sound
            initSounds(); // This would trigger the hit sound in a real implementation
            
            // Reset player position
            gameState.player.x = stages[gameState.currentStage].playerStart.x;
            gameState.player.y = stages[gameState.currentStage].playerStart.y;
            gameState.player.velocityY = 0;
            
            showDialogue('Ouch! Watch out for those slimes!', 2000);
            
            if (gameState.lives <= 0) {
                gameOver();
            }
        }

        // Handle item collection
        function handleItemCollection() {
            const p = gameState.player;
            
            gameState.items.forEach(item => {
                if (!item.collected && checkCollision(p, {x: item.x, y: item.y, width: 20, height: 20})) {
                    item.collected = true;
                    gameState.itemsCollected++;
                    updateStats();
                    
                    // Play collection sound
                    initSounds(); // This would trigger the collection sound in a real implementation
                    
                    let itemName = '';
                    if (item.type === 'key') itemName = 'Key';
                    else if (item.type === 'book') itemName = 'Book';
                    else if (item.type === 'flower') itemName = 'Flower';
                    else if (item.type === 'gem') itemName = 'Gem';
                    else if (item.type === 'scroll') itemName = 'Scroll';
                    
                    showDialogue(`Found a ${itemName}! ${gameState.totalItems - gameState.itemsCollected} left.`, 2000);
                }
            });
        }

        // Handle interaction with boyfriend - AUTO progression when touching
        function handleBoyfriendInteraction() {
            const p = gameState.player;
            const b = gameState.boyfriend;
            
            if (checkCollision(p, b)) {
                if (gameState.itemsCollected === gameState.totalItems) {
                    // All items collected, advance to next stage
                    if (gameState.currentStage < 3) {
                        // Play stage complete sound
                        initSounds(); // This would trigger the stage complete sound in a real implementation
                        
                        gameState.currentStage++;
                        loadStage(gameState.currentStage);
                        showDialogue('Great job! On to the next stage!', 3000);
                    } else {
                        // Game completed
                        showDialogue('You did it! Reda is so happy! Thanks for playing!', 5000);
                        setTimeout(() => {
                            titleScreen.style.display = 'flex';
                            gameState.gameStarted = false;
                        }, 5000);
                    }
                } else {
                    // Not all items collected
                    showDialogue(`I still need ${gameState.totalItems - gameState.itemsCollected} more items!`, 3000);
                }
            }
        }

        // Game over function
        function gameOver() {
            gameState.gameOver = true;
            showDialogue('Game Over! Try again?', 5000);
            setTimeout(() => {
                titleScreen.style.display = 'flex';
                gameState.gameStarted = false;
            }, 5000);
        }

        // Main game loop
        function gameLoop() {
            if (!gameState.gameStarted || gameState.gameOver) return;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Update game state
            handlePlayerMovement();
            handleEnemyMovement();
            handleItemCollection();
            handleBoyfriendInteraction();
            
            // Update dialogue timer
            if (gameState.dialogueTimer > 0) {
                gameState.dialogueTimer -= 16;
                if (gameState.dialogueTimer <= 0) {
                    dialogueBox.style.display = 'none';
                }
            }
            
            // Draw everything
            drawBackground();
            drawPlatforms();
            drawItems();
            drawEnemies();
            drawPlayer();
            drawBoyfriend();
            
            // Update stats
            updateStats();
            
            // Continue game loop
            requestAnimationFrame(gameLoop);
        }

        // Event listeners
        window.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
        });

        window.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });

        startBtn.addEventListener('click', init);

        restartBtn.addEventListener('click', () => {
            if (gameState.gameStarted) {
                loadStage(gameState.currentStage);
                gameState.lives = 3;
                updateHearts();
            }
        });

        // Prevent spacebar from scrolling page
        window.addEventListener('keydown', (e) => {
            if(e.key === ' ' && e.target === document.body) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>